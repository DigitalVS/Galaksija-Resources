# file opened: soundhi.asm
 1    0000
 2    0000              ; ROM routines
 3    0000              CmdRecognize = $039A
 4    0000              CatchAllCmds = $075B
 5    0000
 6    0000              BASICLINK    = $2BA9
 7    0000              RAM_END      = $7000;$9DFE - 60
 8    0000              RAMTOP       = $2A6A
 9    0000
10    0000                .org $7000
11    7000
12    7000              Init:
13    7000 3E C3          ld    a, $C3                  ; Unconditional JMP instruction opcode
14    7002 32 A9 2B       ld    (BASICLINK), a
15    7005 21 12 70       ld    hl, CmdHandler          ; New BASIC command link
16    7008 22 AA 2B       ld    (BASICLINK + 1), hl
17    700B 21 00 70       ld    hl, RAM_END             ; Move RAMTOP lower
18    700E 22 6A 2A       ld    (RAMTOP), hl            ; Set new RAMTOP
19    7011 C9             ret
20    7012
21    7012              CmdHandler:
22    7012 E3             ex    (sp), hl
23    7013 D5             push  de
24    7014 11 5B 07       ld    de, CatchAllCmds
25    7017 D7             rst   $10
26    7018 D1             pop   de
27    7019 28 11          jr    z, .Cmd2
28    701B 7C             ld    a, h
29    701C FE 20          cp    $20                     ; Check address range $20xx - $28xx. This is a trick, because officially commands can be only at addresses up to $4000.
30    701E 38 08          jr    c, .Cmd1
31    7020 FE 28          cp    $28
32    7022 30 04          jr    nc, .Cmd1
33    7024                ; This is our command - transform address higher byte to correct one
34    7024 26 70          ld    h, $70                  ; Set correct higher byte (program start address higher byte)
35    7026 E3             ex    (sp), hl
36    7027 C9             ret
37    7028              .Cmd1:                          ; If address not in range $20xx - $28xx - command not recognized
38    7028 E3             ex    (sp), hl
39    7029 C3 0F 10       jp    $100F                   ; Goto ROM B command handler
40    702C              .Cmd2:                          ; If CmdHandler is called by CatchAllCmds
41    702C E3             ex    (sp), hl
42    702D 21 32 70       ld    hl, CmdTable - 1
43    7030 C3 9A 03       jp    CmdRecognize
44    7033
45    7033              CmdTable:
46    7033 53 4F 55 4E    BYTE "SOUND"
46    7037 44
47    7038 A0             BYTE $A0                      ; Higher byte
48    7039 3C             BYTE CMD_SOUND & $00FF        ; Lower byte
49    703A 90             BYTE $10 + $80                ; 100F (ROM B)
50    703B 0F             BYTE $0F
51    703C
52    703C              CMD_SOUND:
53    703C F1             pop   af                      ; SOUND command code, same as in Galaksija Plus ROM
54    703D CF             rst   $8                      ; Read first parameter
55    703E 7D             ld    a, l                    ; A = sound chip register number
56    703F D3 00          out   ($00), a                ; Send to port $00
57    7041 CD 05 00       call  $0005                   ; Read second parameter
58    7044 7D             ld    a, l                    ; A = data byte to be written to the register
59    7045 D3 01          out   ($01), a                ; Send to port $01
60    7047 F7             rst   $30                     ; Return to BASIC
61    7048
# file closed: soundhi.asm
